name: test

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  detect-services:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.get-services.outputs.services }}
    steps:
      - uses: actions/checkout@v3
      - id: get-services
        run: |
          git fetch origin main
          changedservices=$(git diff --name-only origin/main | \
            grep -Eo '^services/[^/]+' | \
            sed -e 's@^services/@@g' | \
            sort | \
            uniq | \
            xargs echo )
          echo "services=$changedservices" >> $GITHUB_OUTPUT
  trigger-build:
    needs: detect-services
    if: needs.detect-services.outputs.services
    env:
      services: ${{ needs.detect-services.outputs.services }}
    runs-on: ubuntu-latest
    steps:
      - run: |
          json=$(printf '{"ref":"%s", "inputs":{"push":false,"services":"%s"}}' "$GITHUB_HEAD_REF" "$services")
          curl --fail-with-body \
            --location \
            --request POST \
            --header "Accept: application/vnd.github+json" \
            --header "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            --header "X-GitHub-Api-Version: 2022-11-28" \
            --data "$json" \
            --url https://api.github.com/repos/TugboatQA/images/actions/workflows/build.yml/dispatches
